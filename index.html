<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>F√ºr Lena ‚ù§Ô∏è</title>
  <meta name="theme-color" content="#05060b" />
  <meta name="color-scheme" content="dark" />

  <style>
    :root{
      --bg0:#05060b;
      --bg1:#07081a;

      --txt:#ffffff;
      --muted:rgba(255,255,255,.78);

      --glass:rgba(255,255,255,.10);
      --glass2:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);

      --pink:#e64a8d;
      --pink2:#ff6fb2;

      --gold:#ffdc96;
      --gold2:#fff1c6;

      --paperA:#fff7e6;
      --paperB:#f1e6cf;

      --shadow:0 40px 160px rgba(0,0,0,.75);
      --radius:28px;

      --cardW: min(1120px, 92vw);
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBot: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% 15%, rgba(255,220,150,.10), transparent 55%),
        radial-gradient(1000px 700px at 80% 25%, rgba(230,74,141,.10), transparent 55%),
        radial-gradient(1200px 900px at 55% 82%, rgba(255,255,255,.06), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow:hidden;
    }

    canvas{ position:fixed; inset:0; pointer-events:none; }
    #stars{ z-index:0; opacity:.9; }
    #snow{ z-index:1; opacity:.85; }
    #spark{ z-index:16; mix-blend-mode: screen; }
    #confetti{ z-index:17; mix-blend-mode: screen; }
    #fireworks{ z-index:18; mix-blend-mode: screen; }

    #vignette{
      position:fixed; inset:0; z-index:2; pointer-events:none;
      background:
        radial-gradient(circle at 50% 35%, transparent 30%, rgba(0,0,0,.68) 78%),
        radial-gradient(circle at 50% 100%, rgba(0,0,0,.45), transparent 55%);
    }

    .bloom{
      position:fixed; inset:0; z-index:19; pointer-events:none;
      opacity:0;
      background:
        radial-gradient(circle at 50% 40%, rgba(255,241,198,.22), transparent 58%),
        radial-gradient(circle at 50% 60%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(circle at 55% 50%, rgba(255,111,178,.12), transparent 62%);
      filter: blur(10px);
      mix-blend-mode: screen;
      transition: opacity .6s ease;
    }
    .bloom.on{ opacity:1; }

    .aura{
      position:fixed; inset:-30%;
      opacity:0; transform: scale(.98);
      transition: opacity 1.2s ease, transform 1.2s ease;
      z-index:3; pointer-events:none;
      filter: blur(2px);
    }
    .aura.on{ opacity:1; transform: scale(1); }
    .aura::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,220,150,.18), transparent 45%),
        radial-gradient(circle at 72% 38%, rgba(255,255,255,.10), transparent 50%),
        radial-gradient(circle at 52% 78%, rgba(230,90,140,.16), transparent 55%),
        conic-gradient(from 210deg at 60% 30%, rgba(255,220,150,.10), rgba(230,74,141,.06), rgba(255,255,255,.05), rgba(255,220,150,.10));
      animation: breathe 7.6s ease-in-out infinite;
      mix-blend-mode: screen;
      opacity:.9;
    }
    @keyframes breathe{
      0%,100%{ transform:scale(1); opacity:.78 }
      50%{ transform:scale(1.14); opacity:1 }
    }

    .wrap{
      position:relative;
      z-index:4;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding: calc(22px + var(--safeTop)) 18px calc(22px + var(--safeBot)) 18px;
      transform: translateZ(0);
    }

    .punch{ animation: punch .55s cubic-bezier(.2,.9,.2,1) both; }
    @keyframes punch{
      0%{ transform: scale(1) translate3d(0,0,0); }
      35%{ transform: scale(1.012) translate3d(0,-2px,0); }
      55%{ transform: scale(0.995) translate3d(0,1px,0); }
      100%{ transform: scale(1) translate3d(0,0,0); }
    }

    .card{
      width:var(--cardW);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(135deg, rgba(255,255,255,.10), transparent 40%),
        radial-gradient(900px 460px at 10% 0%, rgba(255,220,150,.11), transparent 65%),
        radial-gradient(860px 460px at 100% 30%, rgba(230,74,141,.09), transparent 60%);
      pointer-events:none;
    }

    .inner{ position:relative; padding: 34px 26px 28px; }

    header{ text-align:center; margin-bottom: 18px; }
    h1{
      margin: 0 0 10px;
      font-size: clamp(26px, 3.2vw, 46px);
      letter-spacing:.2px;
      line-height:1.1;
    }
    .sub{
      margin:0 auto;
      max-width: 72ch;
      font-size: clamp(14px, 1.4vw, 17px);
      color:var(--muted);
      line-height:1.55;
    }

    .stage{
      margin-top: 24px;
      display:grid;
      place-items:center;
      gap: 14px;
      padding: 18px 0 6px;
      position:relative;
    }

    .hint{
      font-size: 13px;
      color: rgba(255,255,255,.72);
      min-height: 1.4em;
      text-align:center;
    }

    .controls{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-top: 6px;
    }
    .btn{
      border:none;
      cursor:pointer;
      border-radius: 18px;
      padding: 15px 18px;
      font-weight: 900;
      font-size: 16px;
      color:#121212;
      background: linear-gradient(180deg, #ffffff, #ededed);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: scale(.98); }
    .btn.secondary{
      color: rgba(255,255,255,.88);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: none;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(255,255,255,.84);
      font-size: 13px;
      user-select:none;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle, var(--gold2), var(--gold));
      box-shadow: 0 0 16px rgba(255,220,150,.6);
      opacity:.85;
    }

    /* Gift scene */
    .giftScene{
      width: min(680px, 94vw);
      height: 420px;
      display:grid;
      place-items:center;
      position:relative;
      perspective: 1300px;
    }

    .spot{
      position:absolute;
      width: 500px;
      height: 180px;
      bottom: 44px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,220,150,.20), rgba(230,74,141,.11), transparent 70%);
      filter: blur(16px);
      opacity:.55;
      transform: translateZ(-40px);
      transition: opacity .8s ease;
    }

    .gift{
      position:relative;
      width: 185px;
      height: 170px;
      transform-style: preserve-3d;
      animation: float 3.3s ease-in-out infinite;
      filter: drop-shadow(0 35px 60px rgba(0,0,0,.55));
      will-change: transform;
      z-index: 8;
    }
    @keyframes float{
      0%,100%{ transform: translateY(0) rotateX(2deg) rotateY(-12deg); }
      50%{ transform: translateY(-15px) rotateX(3deg) rotateY(-16deg); }
    }

    /* OPEN: gift lifts upward so glow remains visible "from the box" */
    .open .gift{
      animation: liftGift 1.25s cubic-bezier(.2,.95,.2,1) .10s forwards;
    }
    @keyframes liftGift{
      0%{ transform: translateY(0) rotateX(2deg) rotateY(-12deg); }
      55%{ transform: translateY(-105px) rotateX(4deg) rotateY(-10deg) scale(.99); }
      100%{ transform: translateY(-120px) rotateX(4deg) rotateY(-10deg) scale(.985); }
    }

    .box{
      position:absolute;
      inset: 44px 0 0 0;
      border-radius: 0 0 14px 14px;
      background: linear-gradient(180deg, #ffffff, #f2f2f2);
      overflow:hidden;
      z-index: 6;
    }
    .box::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(110px 75px at 25% 16%, rgba(255,255,255,.75), transparent 70%),
        linear-gradient(90deg, rgba(0,0,0,.04), transparent 35%, rgba(0,0,0,.05));
      pointer-events:none;
      opacity:.65;
    }

    .lid{
      position:absolute;
      left:-6%;
      top: 14px;
      width: 112%;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(180deg, #ffffff, #f1f1f1);
      transform-origin: 16% 100%;
      transition: transform 1050ms cubic-bezier(.2,.9,.2,1);
      box-shadow: 0 14px 22px rgba(0,0,0,.18);
      overflow:hidden;
      z-index:9;
    }
    .lid::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(0,0,0,.05), transparent 40%, rgba(0,0,0,.06));
      opacity:.6;
      pointer-events:none;
    }

    .ribV, .ribV-lid{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      width: 18px;
      background: linear-gradient(180deg, var(--pink2), var(--pink));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.14);
    }
    .ribV{ top:0; bottom:0; }
    .ribV-lid{ top:0; bottom:0; opacity:.98; }
    .ribH{
      position:absolute;
      left:0; right:0;
      top: 44%;
      height: 16px;
      background: linear-gradient(180deg, var(--pink2), var(--pink));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.14);
    }

    .bow{
      position:absolute;
      left:50%;
      top: -2px;
      width: 78px;
      height: 40px;
      transform: translateX(-50%);
      z-index:3;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.22));
    }
    .bow::before,
    .bow::after{
      content:"";
      position:absolute;
      width: 38px; height: 26px;
      top: 8px;
      border-radius: 16px;
      background: linear-gradient(180deg, var(--pink2), var(--pink));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.14);
    }
    .bow::before{ left:2px; transform: rotate(-18deg); }
    .bow::after{ right:2px; transform: rotate(18deg); }
    .knot{
      position:absolute;
      left:50%; top: 14px;
      width: 14px; height: 14px;
      transform: translateX(-50%);
      border-radius: 6px;
      background: linear-gradient(180deg, var(--pink2), var(--pink));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
      z-index:4;
    }

    /* Opening seam glow */
    .glow{
      position:absolute;
      left: 10%;
      right: 10%;
      top: 50px;
      height: 110px;
      opacity:0;
      background: radial-gradient(circle, var(--gold2) 0%, var(--gold) 48%, transparent 76%);
      filter: blur(22px);
      transform: translateZ(0);
      transition: opacity .8s ease;
      pointer-events:none;
      z-index:4;
    }

    /* ===== Premium Volumetric Beams (replaces old rays) ===== */
.rays{
  position:absolute;
  left: 50%;
  top: 48px;                 /* Ursprung nahe √ñffnung */
  width: 440px;
  height: 360px;
  transform: translateX(-50%);
  opacity: 0;
  pointer-events:none;
  z-index: 7;                /* √ºber Glow, unter Lid/Letter */
  mix-blend-mode: screen;
  filter: blur(.3px);
  transition: opacity .9s ease;
}

/* Beam layers */
.rays::before,
.rays::after{
  content:"";
  position:absolute;
  inset:-80px;
  background:
    conic-gradient(from 240deg at 50% 16%,
      transparent 0 8deg,
      rgba(255,241,198,.28) 8deg 14deg,
      transparent 14deg 26deg,
      rgba(255,220,150,.24) 26deg 32deg,
      transparent 32deg 44deg,
      rgba(255,255,255,.18) 44deg 49deg,
      transparent 49deg 360deg);
  /* ‚ÄúVolumetric‚Äù falloff */
  -webkit-mask-image: radial-gradient(circle at 50% 10%, rgba(0,0,0,1), transparent 68%);
  mask-image: radial-gradient(circle at 50% 10%, rgba(0,0,0,1), transparent 68%);
  opacity: .0;
  transform-origin: 50% 12%;
}

.rays::before{
  filter: blur(0.6px);
  opacity: .95;
  animation: beamSweep 4.6s ease-in-out infinite;
}

.rays::after{
  /* softer secondary layer for depth */
  inset:-110px;
  opacity: .75;
  filter: blur(2.6px);
  animation: beamSweep2 6.2s ease-in-out infinite;
}

/* Extra: subtle moving grain/noise overlay to avoid ‚Äústatic & cheap‚Äù feel */
.rays .noise{
  position:absolute;
  inset:-50px;
  opacity: .0;
  background:
    repeating-linear-gradient(0deg, rgba(255,255,255,.07) 0 1px, transparent 1px 3px),
    repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 1px, transparent 1px 4px);
  mix-blend-mode: overlay;
  filter: blur(1.8px);
  transform: translateZ(0);
  animation: noiseDrift 1.6s linear infinite;
  -webkit-mask-image: radial-gradient(circle at 50% 12%, rgba(0,0,0,1), transparent 70%);
  mask-image: radial-gradient(circle at 50% 12%, rgba(0,0,0,1), transparent 70%);
}

/* Soft ‚Äúbeam core‚Äù ‚Äì looks like real light column */
.rays .core{
  position:absolute;
  left:50%;
  top: 10px;
  width: 320px;
  height: 280px;
  transform: translateX(-50%);
  background: radial-gradient(closest-side at 50% 0%,
    rgba(255,241,198,.30),
    rgba(255,220,150,.20) 35%,
    transparent 72%);
  filter: blur(16px);
  opacity: 0;
  mix-blend-mode: screen;
}

/* Open state: visible, alive, not static */
.open .rays{
  opacity: 1;
}

.open .rays .noise{ opacity: .18; }
.open .rays .core{
  opacity: .90;
  animation: coreBreath 2.9s ease-in-out infinite;
}

/* Animations */
@keyframes beamSweep{
  0%,100%{ transform: rotate(-7deg) scale(1); opacity:.78; }
  50%{ transform: rotate(10deg) scale(1.03); opacity:1; }
}
@keyframes beamSweep2{
  0%,100%{ transform: rotate(9deg) scale(1); opacity:.55; }
  50%{ transform: rotate(-10deg) scale(1.02); opacity:.82; }
}
@keyframes coreBreath{
  0%,100%{ transform: translateX(-50%) scale(.94); opacity:.68; }
  50%{ transform: translateX(-50%) scale(1.05); opacity:1; }
}
@keyframes noiseDrift{
  0%{ transform: translate3d(-6px,-6px,0); }
  100%{ transform: translate3d(6px,6px,0); }
}


    /* =================== BIG FOLDING LETTER (NOW OUTSIDE GIFT) =================== */
    .letter{
      position:absolute;
      left: 50%;
      top: 98px;
      width: min(560px, 94vw);
      height: min(340px, 56vw);
      max-height: 360px;
      transform: translate(-50%, 110px) rotateX(78deg) rotateZ(-2deg);
      transform-style: preserve-3d;
      opacity:0;
      z-index: 12; /* above gift (gift z-index 8) */
      pointer-events:none;
      filter: drop-shadow(0 32px 46px rgba(0,0,0,.48));
    .letter{ filter: drop-shadow(0 38px 60px rgba(0,0,0,.52)); }

    }

    .sheet{
      position:absolute; inset:0;
      border-radius: 22px;
      background:
        radial-gradient(180px 120px at 20% 25%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(240px 180px at 82% 70%, rgba(255,255,255,.35), transparent 62%),
        linear-gradient(180deg, var(--paperA), var(--paperB));
      border: 1px solid rgba(0,0,0,.12);
      overflow:hidden;
      transform-style: preserve-3d;
    }
    .sheet::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(0deg, rgba(0,0,0,.016) 0 1px, transparent 1px 3px),
        repeating-linear-gradient(90deg, rgba(0,0,0,.010) 0 1px, transparent 1px 4px);
      opacity:.55;
      mix-blend-mode: multiply;
      pointer-events:none;
    }
    .sheet::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(circle at 50% 40%, transparent 55%, rgba(0,0,0,.14) 92%);
      opacity:.28;
      pointer-events:none;
    }

    .sealBand{
      position:absolute;
      left:0; right:0; top:0;
      height: 60px;
      background: linear-gradient(90deg, rgba(230,74,141,.96), rgba(255,111,178,.96));
      box-shadow: inset 0 -1px 0 rgba(255,255,255,.35);
      z-index:2;
    }
    .sealBand::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(240px 80px at 20% 30%, rgba(255,255,255,.35), transparent 70%);
      opacity:.85;
    }

    .sealTitle{
      position:absolute;
      left: 18px;
      top: 18px;
      z-index:3;
      color: rgba(255,255,255,.96);
      font-weight: 950;
      letter-spacing:.55px;
      font-size: 13px;
      text-transform: uppercase;
    }

    /* Monogram (visible + pulse on reveal) */
    .mono{
      position:absolute;
      left: 18px;
      top: 12px;
      width: 94px;
      height: 94px;
      z-index:4;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), rgba(255,241,198,.22) 40%, rgba(255,255,255,.10) 72%),
        linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.38);
      box-shadow:
        0 12px 26px rgba(0,0,0,.22),
        0 0 22px rgba(255,220,150,.28);
      display:grid;
      place-items:center;
      opacity: .98;
      mix-blend-mode: normal;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      transform: translateZ(10px);
    }
    .mono span{
      font-weight: 1000;
      letter-spacing: 1px;
      font-size: 28px;
      color: rgba(255,255,255,.96);
      text-shadow:
        0 1px 0 rgba(0,0,0,.18),
        0 0 18px rgba(255,220,150,.35);
    }

    .wax{
      position:absolute;
      right: 16px;
      top: 10px;
      width: 48px;
      height: 48px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.35), transparent 55%),
        radial-gradient(circle at 70% 80%, rgba(0,0,0,.18), transparent 55%),
        linear-gradient(180deg, #b1133e, #7a0c28);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.16);
      transform: rotate(-10deg);
      filter: drop-shadow(0 12px 18px rgba(0,0,0,.22));
      opacity:.92;
      z-index:4;
    }
    .wax::after{
      content:"‚ù§";
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      color: rgba(255,255,255,.92);
      font-weight: 950;
      font-size: 20px;
      text-shadow: 0 2px 10px rgba(0,0,0,.25);
      transform: translateY(-1px);
    }

    .flap{
      position:absolute;
      top: 60px;
      bottom: 0;
      width: 50%;
      background:
        radial-gradient(180px 140px at 30% 38%, rgba(255,255,255,.28), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.36), rgba(255,255,255,.16));
      mix-blend-mode: multiply;
      opacity:.32;
      pointer-events:none;
      z-index:1;
      filter: blur(.15px);
    }
    .flap.left{
      left:0;
      transform-origin: 0% 50%;
      transform: rotateY(0deg);
      border-right: 1px solid rgba(0,0,0,.08);
    }
    .flap.right{
      right:0;
      transform-origin: 100% 50%;
      transform: rotateY(0deg);
      border-left: 1px solid rgba(0,0,0,.08);
    }
    .flap.left::after,
    .flap.right::after{
      content:"";
      position:absolute;
      top:0; bottom:0;
      width:18px;
      pointer-events:none;
      opacity:.55;
      background: linear-gradient(180deg, rgba(0,0,0,.10), transparent 40%, rgba(0,0,0,.08));
    }
    .flap.left::after{ right:0; }
    .flap.right::after{ left:0; }

    .letterBody{
      position:absolute;
      left: 18px;
      right: 18px;
      top: 78px;
      bottom: 16px;
      z-index:3;
      color: rgba(0,0,0,.80);
      display:grid;
      gap: 12px;
      align-content:start;
    }

    .writeWrap{ position:relative; height: 46px; overflow:hidden; }
    svg.write{ width: 100%; height: 46px; }
    .write path{
      fill: none;
      stroke: rgba(0,0,0,.70);
      stroke-width: 3.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 900;
      stroke-dashoffset: 900;
    }

    .vouchers{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    .voucher{
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 12px 26px rgba(0,0,0,.12);
      position:relative;
      overflow:hidden;
      opacity:0;
      transform: translateY(10px) scale(.985);
    }
    .voucher::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(260px 110px at 12% 10%, rgba(255,255,255,.88), transparent 65%);
      opacity:.6;
      pointer-events:none;
    }
    .voucher h3{
      margin:0 0 4px;
      font-size: 16px;
      letter-spacing:.2px;
      color: rgba(0,0,0,.88);
      font-weight: 950;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .voucher p{
      margin:0;
      font-size: 13px;
      color: rgba(0,0,0,.72);
      line-height:1.38;
      font-weight: 750;
    }
    .tag{
      margin-left:auto;
      font-size: 11px;
      padding: 5px 9px;
      border-radius: 999px;
      background: rgba(230,74,141,.14);
      border: 1px solid rgba(230,74,141,.18);
      color: rgba(0,0,0,.74);
      font-weight: 950;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .sign{
      font-family: "Segoe Script", "Brush Script MT", "Comic Sans MS", cursive;
      font-weight: 800;
      font-size: 16px;
      color: rgba(0,0,0,.70);
      text-align:right;
      opacity:.0;
      transform: translateY(8px);
    }

    .gloss{
      position:absolute;
      inset:-60px;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.55) 48%, transparent 60%);
      transform: translateX(-60%) rotate(8deg);
      opacity:0;
      z-index:5;
      pointer-events:none;
    }

    /* ================= OPEN STATE ================= */

    .open .glow{
      opacity:1;
      animation: glowBreath 3.2s ease-in-out infinite;
    }
    @keyframes glowBreath{
      0%,100%{ transform: scale(.92); opacity:.55; }
      50%{ transform: scale(1.18); opacity: 1; }
    }
    .open .rays{ opacity:1; }

    /* Lid still flips open (keeps box visible) */
    .open .lid{
      transform: rotate(-74deg) translate(-22px, -32px);
    }

    /* Letter appears + cinematic zoom */
    .open .letter{
      opacity:1;
      animation:
        letterOut 1.55s cubic-bezier(.2,.9,.2,1) both,
        materialize 700ms ease-out 0ms both,
        letterZoom 950ms cubic-bezier(.2,1.05,.2,1) 1.30s both;
    }
    @keyframes materialize{
      0%{ opacity:0; filter: drop-shadow(0 0 0 rgba(0,0,0,0)) blur(6px); }
      45%{ opacity:1; filter: drop-shadow(0 18px 28px rgba(0,0,0,.22)) blur(1.8px); }
      100%{ opacity:1; filter: drop-shadow(0 32px 46px rgba(0,0,0,.48)) blur(0px); }
    }
    @keyframes letterOut{
      0%{ transform: translate(-50%, 120px) rotateX(80deg) rotateZ(-2deg); }
      55%{ transform: translate(-50%, 10px) rotateX(18deg) rotateZ(1deg); }
      100%{ transform: translate(-50%, -18px) rotateX(9deg) rotateZ(0deg); }
    }
    @keyframes letterZoom{
      0%{ transform: translate(-50%, -18px) rotateX(9deg) rotateZ(0deg) scale(1); }
      45%{ transform: translate(-50%, -18px) rotateX(9deg) rotateZ(0deg) scale(1.045); }
      100%{ transform: translate(-50%, -18px) rotateX(9deg) rotateZ(0deg) scale(1.02); }
    }

    /* Flaps unfold */
    .open .flap.left{ animation: flapLeft 1.05s cubic-bezier(.15,1.1,.2,1) .55s both; }
    .open .flap.right{ animation: flapRight 1.05s cubic-bezier(.15,1.1,.2,1) .60s both; }
    @keyframes flapLeft{ 0%{ transform: rotateY(0deg); opacity:.32; } 100%{ transform: rotateY(-150deg); opacity:0; } }
    @keyframes flapRight{ 0%{ transform: rotateY(0deg); opacity:.32; } 100%{ transform: rotateY(150deg); opacity:0; } }

    .open .gloss{
      opacity:1;
      animation: gloss 1.2s ease-out 0.7s both;
    }
    @keyframes gloss{
      0%{ transform: translateX(-60%) rotate(8deg); opacity:0; }
      30%{ opacity:.55; }
      100%{ transform: translateX(80%) rotate(8deg); opacity:0; }
    }

    /* Monogram WOW pulse + wax pulse */
    .open .mono{ animation: monoPulse 1.05s cubic-bezier(.2,1.1,.2,1) .72s both; }
    .open .wax{ animation: waxPulse 1.05s cubic-bezier(.2,1.1,.2,1) .74s both; }
    @keyframes monoPulse{
      0%{ transform: translateZ(10px) scale(.92); box-shadow: 0 12px 26px rgba(0,0,0,.22), 0 0 14px rgba(255,220,150,.18); }
      55%{ transform: translateZ(10px) scale(1.08); box-shadow: 0 16px 30px rgba(0,0,0,.22), 0 0 46px rgba(255,220,150,.55); }
      100%{ transform: translateZ(10px) scale(1.00); box-shadow: 0 12px 26px rgba(0,0,0,.22), 0 0 22px rgba(255,220,150,.28); }
    }
    @keyframes waxPulse{
      0%{ transform: rotate(-10deg) scale(.94); filter: drop-shadow(0 10px 14px rgba(0,0,0,.18)); }
      55%{ transform: rotate(-10deg) scale(1.08); filter: drop-shadow(0 18px 22px rgba(0,0,0,.22)); }
      100%{ transform: rotate(-10deg) scale(1.00); filter: drop-shadow(0 12px 18px rgba(0,0,0,.22)); }
    }

    .open .write path{ animation: write 2.2s ease 0.85s forwards; }
    @keyframes write{ to{ stroke-dashoffset: 0; } }

    .open .voucher.one{ animation: popIn .75s cubic-bezier(.2,.9,.2,1) 1.15s forwards; }
    .open .voucher.two{ animation: popIn .75s cubic-bezier(.2,.9,.2,1) 1.35s forwards; }
    @keyframes popIn{
      from{ opacity:0; transform: translateY(10px) scale(.985); }
      to{ opacity:1; transform: translateY(0) scale(1); }
    }

    .open .sign{ animation: signIn .9s ease 1.65s forwards; }
    @keyframes signIn{ to{ opacity:.9; transform: translateY(0); } }

    .reveal{
      margin-top: 18px;
      opacity:0;
      transform: translateY(16px);
      transition: opacity 900ms ease, transform 900ms ease;
    }
    .reveal.show{ opacity:1; transform:none; }

    .grid{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr;
      margin-top: 8px;
    }
    .item{
      border-radius: 20px;
      padding: 16px 16px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 20px 70px rgba(0,0,0,.28);
    }
    .item strong{ display:block; font-size: 16px; margin-bottom: 6px; letter-spacing:.2px; }
    .item p{ margin:0; color: rgba(255,255,255,.82); line-height: 1.55; font-size: 14px; }
    .love{
      margin: 14px 0 0;
      text-align:center;
      color: rgba(255,255,255,.86);
      font-size: 14px;
      opacity:.9;
    }
    .footer{
      margin-top: 18px;
      display:flex;
      justify-content:center;
      gap: 10px;
      flex-wrap:wrap;
      opacity:.9;
    }

    @media (min-width: 820px){
      .grid{ grid-template-columns: 1fr 1fr; }
      .inner{ padding: 40px 40px 32px; }
      .vouchers{ grid-template-columns: 1fr 1fr; }
      .writeWrap{ height: 50px; }
      svg.write{ height: 50px; }
      .mono{ width: 104px; height: 104px; }
      .mono span{ font-size: 30px; }
    }

    @media (prefers-reduced-motion: reduce){
      .aura::before{ animation:none; }
      #snow, #spark, #confetti, #stars, #fireworks{ display:none; }
      .open .letter{ animation:none; opacity:1; transform: translate(-50%,-18px) rotateX(0) }
      .open .flap.left, .open .flap.right{ animation:none; opacity:0; }
      .open .write path{ animation:none; stroke-dashoffset:0; }
      .open .voucher.one, .open .voucher.two{ animation:none; opacity:1; transform:none; }
      .open .sign{ animation:none; opacity:1; transform:none; }
      .punch{ animation:none; }
      .bloom{ display:none; }
    }


    /* ===== Cinematic Lens Sweep ===== */
.lensSweep{
  position:absolute;
  inset:-120px;
  z-index: 15; /* √ºber Rays, unter UI */
  pointer-events:none;
  opacity:0;
  background:
    linear-gradient(
      115deg,
      transparent 35%,
      rgba(255,255,255,.35) 48%,
      rgba(255,241,198,.55) 50%,
      rgba(255,255,255,.35) 52%,
      transparent 65%
    );
  filter: blur(14px);
  transform: translateX(-120%) rotate(6deg);
  mix-blend-mode: screen;
}

.open .lensSweep{
  animation: lensSweep 1.15s cubic-bezier(.2,.9,.2,1) .35s both;
}

@keyframes lensSweep{
  0%{
    opacity:0;
    transform: translateX(-120%) rotate(6deg);
  }
  25%{
    opacity:.85;
  }
  100%{
    opacity:0;
    transform: translateX(120%) rotate(6deg);
  }
}

  </style>
</head>

<body>
  <canvas id="stars"></canvas>
  <canvas id="snow"></canvas>
  <canvas id="spark"></canvas>
  <canvas id="confetti"></canvas>
  <canvas id="fireworks"></canvas>

  <div id="vignette"></div>
  <div class="aura" id="aura"></div>
  <div class="bloom" id="bloom"></div>

  <main class="wrap" id="wrap">
    <section class="card" aria-label="Weihnachts√ºberraschung">
      <div class="inner">
        <header>
          <h1>Frohe Weihnachten, mein Schatz ‚ù§Ô∏è</h1>
          <p class="sub">
            Gleich passiert etwas Magie. ‚ú®<br/>
            Wenn du bereit bist‚Ä¶ √∂ffne das Geschenk.
          </p>
        </header>

        <div class="stage">
          <div class="giftScene" id="scene" aria-hidden="true">
            <div class="spot" id="spot"></div>

            <!-- Gift stays visible -->
            <div class="gift" id="gift">
              <div class="flash"></div>

              <div class="lid">
                <div class="ribV-lid"></div>
                <div class="bow"></div>
                <div class="knot"></div>
              </div>

              <div class="glow"></div>
              <div class="rays">
  	       <div class="core"></div>
  	       <div class="noise"></div>
	      </div>

	      <div class="lensSweep"></div>



              <div class="box">
                <div class="ribV"></div>
                <div class="ribH"></div>
              </div>
            </div>

            <!-- Letter is OUTSIDE the gift, so it can stay below while gift moves up -->
            <div class="letter" id="letter">
              <div class="sheet">
                <div class="sealBand"></div>
                <div class="sealTitle">Gutscheinbrief ‚Ä¢ nur f√ºr dich</div>

                <div class="mono" aria-hidden="true"><span>Y ‚ô• L</span></div>
                <div class="wax" aria-hidden="true"></div>

                <div class="flap left"></div>
                <div class="flap right"></div>
                <div class="gloss" aria-hidden="true"></div>

                <div class="letterBody">
                  <div class="writeWrap">
                    <svg class="write" viewBox="0 0 900 80" preserveAspectRatio="xMinYMid meet" aria-hidden="true">
                      <path d="M40,55
                               C60,25 80,25 96,55
                               C110,82 130,80 145,56
                               C158,34 175,30 188,44
                               C200,56 210,70 230,60
                               C255,48 270,25 290,42
                               C310,58 322,74 350,58
                               C372,46 390,22 412,38
                               C438,58 455,76 484,58
                               C510,42 525,30 548,40
                               C572,50 590,68 616,60
                               C650,48 662,25 686,38
                               C712,52 730,78 760,60
                               C784,48 802,38 830,46
                               C850,52 870,60 890,62" />
                    </svg>
                  </div>

                  <div class="vouchers">
                    <div class="voucher one">
                      <h3>üé≠ Theater / Musical <span class="tag">Du entscheidest</span></h3>
                      <p>Du suchst aus, worauf du Lust hast ‚Äì ich plane den Abend und wir machen ihn perfekt. ‚ù§Ô∏è</p>
                    </div>

                    <div class="voucher two">
                      <h3>üé∏ Deine Gitarre <span class="tag">Neustart</span></h3>
                      <p>Neue Saiten, stimmen & sch√∂n machen lassen ‚Äì damit du wieder richtig Bock hast zu spielen. ‚ù§Ô∏è</p>
                    </div>
                  </div>

                  <div class="sign">Ich liebe dich. ‚ù§Ô∏è</div>
                </div>
              </div>
            </div>

          </div>

          <div class="controls">
            <button class="btn" id="startBtn">üéÅ Geschenk √∂ffnen</button>
            <span class="pill" id="pill" style="display:none">
              <span class="dot"></span>
              <span id="pillText">Sternenstaub sammelt sich‚Ä¶</span>
            </span>
          </div>

          <div class="hint" id="hint">Tippe auf ‚ÄûGeschenk √∂ffnen‚Äú. (Wenn Musik blockiert wird: nochmal tippen.)</div>
        </div>

        <div class="reveal" id="reveal" aria-live="polite">
          <div class="grid">
            <div class="item">
              <strong>‚ú® Kleines Extra</strong>
              <p>Wenn du willst: wir machen daraus direkt ein Datum ‚Äî Tag + Outfit + Essen danach. ‚ù§Ô∏è</p>
            </div>
            <div class="item">
              <strong>üíå Erinnerung</strong>
              <p>Das ist dein digitaler Gutscheinbrief ‚Äî der immer wieder ‚Äúaufgeht‚Äù.</p>
            </div>
          </div>

          <p class="love">F√ºr uns. F√ºr Momente. F√ºr Liebe. ‚ù§Ô∏è</p>

          <div class="footer">
            <span class="pill"><span class="dot"></span> Magie</span>
            <span class="pill"><span class="dot"></span> Zeit</span>
            <span class="pill"><span class="dot"></span> Wir</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <audio id="music" preload="auto">
    <source src="music.mp3" type="audio/mpeg" />
  </audio>

  <script>
    // ===================== TIMING =====================
    const REVEAL_AT = 25.263;
    const HEART_FORM_START = REVEAL_AT - 2.1;
    const HEART_FORM_END   = REVEAL_AT - 0.35;

    // ===================== EFFECT SETTINGS =====================
    const SPARK_COUNT = 420;
    const GOLD = ["#fff1c6","#ffdc96","#ffd700","#ffb300","#fff7de","#ffffff","#ff6fb2"];
    const SWIRL_Y_OFFSET = -125;

    const CONFETTI_BURST = 240;
    const FIREWORK_BURSTS = 12;
    const FIREWORK_PARTS  = 48;

    // ===================== ELEMENTS =====================
    const wrap = document.getElementById("wrap");
    const scene = document.getElementById("scene");
    const gift = document.getElementById("gift");
    const reveal = document.getElementById("reveal");
    const startBtn = document.getElementById("startBtn");
    const hint = document.getElementById("hint");
    const aura = document.getElementById("aura");
    const spot = document.getElementById("spot");
    const pill = document.getElementById("pill");
    const pillText = document.getElementById("pillText");
    const music = document.getElementById("music");
    const bloom = document.getElementById("bloom");

    let started = false;
    let opened = false;

    // ===================== WEB AUDIO =====================
    let audioCtx = null;
    function ensureAudio(){
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }

    // soft musical chime
    function chime(){
      try{
        const ctx = ensureAudio();
        const t0 = ctx.currentTime;

        const master = ctx.createGain();
        master.gain.setValueAtTime(0.0001, t0);
        master.gain.exponentialRampToValueAtTime(0.26, t0 + 0.02);
        master.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.35);
        master.connect(ctx.destination);

        const freqs = [523.25, 659.25, 783.99, 1046.5];
        freqs.forEach((f, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine";
          o.frequency.setValueAtTime(f, t0);

          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(0.18/(i+1), t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + 1.12 + i*0.10);

          o.connect(g);
          g.connect(master);

          o.start(t0 + i*0.02);
          o.stop(t0 + 1.2 + i*0.14);
        });
      }catch(_){}
    }

    // wax seal stamp: thump + click + tiny shimmer
    function waxStamp(){
      try{
        const ctx = ensureAudio();
        const t0 = ctx.currentTime;

        const master = ctx.createGain();
        master.gain.setValueAtTime(0.0001, t0);
        master.gain.exponentialRampToValueAtTime(0.26, t0 + 0.01);
        master.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.28);
        master.connect(ctx.destination);

        // thump
        const th = ctx.createOscillator();
        th.type = "sine";
        th.frequency.setValueAtTime(120, t0);
        const thG = ctx.createGain();
        thG.gain.setValueAtTime(0.0001, t0);
        thG.gain.exponentialRampToValueAtTime(0.45, t0 + 0.008);
        thG.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.12);
        th.connect(thG); thG.connect(master);
        th.start(t0); th.stop(t0 + 0.14);

        // click
        const ck = ctx.createOscillator();
        ck.type = "square";
        ck.frequency.setValueAtTime(980, t0 + 0.015);
        const ckG = ctx.createGain();
        ckG.gain.setValueAtTime(0.0001, t0 + 0.015);
        ckG.gain.exponentialRampToValueAtTime(0.18, t0 + 0.02);
        ckG.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.055);
        ck.connect(ckG); ckG.connect(master);
        ck.start(t0 + 0.015); ck.stop(t0 + 0.08);

        // shimmer
        const sh = ctx.createOscillator();
        sh.type = "sine";
        sh.frequency.setValueAtTime(1480, t0 + 0.04);
        const shG = ctx.createGain();
        shG.gain.setValueAtTime(0.0001, t0 + 0.04);
        shG.gain.exponentialRampToValueAtTime(0.10, t0 + 0.06);
        shG.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
        sh.connect(shG); shG.connect(master);
        sh.start(t0 + 0.04); sh.stop(t0 + 0.20);
      }catch(_){}
    }

    // paper scratch + tiny clicks during handwriting
    function typewriter(durationSec = 2.2){
      try{
        const ctx = ensureAudio();
        const t0 = ctx.currentTime;

        const master = ctx.createGain();
        master.gain.setValueAtTime(0.0001, t0);
        master.gain.exponentialRampToValueAtTime(0.12, t0 + 0.02);
        master.gain.exponentialRampToValueAtTime(0.0001, t0 + durationSec + 0.12);
        master.connect(ctx.destination);

        const bufferSize = 2 * ctx.sampleRate;
        const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const output = noiseBuffer.getChannelData(0);
        for(let i=0;i<bufferSize;i++) output[i] = (Math.random()*2 - 1) * 0.35;

        const noise = ctx.createBufferSource();
        noise.buffer = noiseBuffer;
        noise.loop = true;

        const hp = ctx.createBiquadFilter();
        hp.type = "highpass";
        hp.frequency.setValueAtTime(1200, t0);

        const lp = ctx.createBiquadFilter();
        lp.type = "lowpass";
        lp.frequency.setValueAtTime(5200, t0);

        const ng = ctx.createGain();
        ng.gain.setValueAtTime(0.02, t0);

        noise.connect(hp); hp.connect(lp); lp.connect(ng); ng.connect(master);

        const clickGain = ctx.createGain();
        clickGain.gain.setValueAtTime(0.0001, t0);
        clickGain.connect(master);

        const clicks = Math.floor(durationSec * 14);
        for(let i=0;i<clicks;i++){
          const tt = t0 + i*(durationSec/clicks);

          const o = ctx.createOscillator();
          o.type = "square";
          o.frequency.setValueAtTime(180 + Math.random()*60, tt);

          const g = ctx.createGain();
          g.gain.setValueAtTime(0.0001, tt);
          g.gain.exponentialRampToValueAtTime(0.08 + Math.random()*0.05, tt + 0.004);
          g.gain.exponentialRampToValueAtTime(0.0001, tt + 0.03 + Math.random()*0.03);

          o.connect(g);
          g.connect(clickGain);

          o.start(tt);
          o.stop(tt + 0.08);
        }

        noise.start(t0);
        noise.stop(t0 + durationSec + 0.14);
      }catch(_){}
    }

    // ===================== CANVAS: STARS =====================
    const starsC = document.getElementById("stars");
    const stx = starsC.getContext("2d", { alpha:true });
    let stw=0, sth=0, stars=[];
    function resizeStars(){
      stw = starsC.width = window.innerWidth;
      sth = starsC.height = window.innerHeight;
      const n = Math.min(280, Math.max(150, Math.floor((stw*sth)/20500)));
      stars = Array.from({length:n}, () => ({
        x: Math.random()*stw,
        y: Math.random()*sth,
        r: 0.5 + Math.random()*1.7,
        a: 0.18 + Math.random()*0.85,
        tw: 0.002 + Math.random()*0.006,
        ph: Math.random()*Math.PI*2
      }));
    }
    window.addEventListener("resize", resizeStars, { passive:true });
    resizeStars();
    (function tickStars(){
      stx.clearRect(0,0,stw,sth);
      const t = Date.now()*0.001;
      for(const s of stars){
        const tw = 0.5 + Math.sin(t*s.tw*60 + s.ph)*0.5;
        stx.globalAlpha = Math.max(0, Math.min(1, s.a*tw));
        stx.fillStyle = "#ffffff";
        stx.beginPath();
        stx.arc(s.x, s.y, s.r*(0.85 + tw*0.35), 0, Math.PI*2);
        stx.fill();
      }
      stx.globalAlpha = 1;
      requestAnimationFrame(tickStars);
    })();

    // ===================== CANVAS: SNOW =====================
    const snowC = document.getElementById("snow");
    const nCtx = snowC.getContext("2d", { alpha:true });
    let nw=0, nh=0, snow=[];
    function resizeSnow(){
      nw = snowC.width = window.innerWidth;
      nh = snowC.height = window.innerHeight;
      const count = Math.min(140, Math.max(80, Math.floor((nw*nh)/18000)));
      snow = Array.from({ length: count }, () => ({
        x: Math.random()*nw,
        y: Math.random()*nh,
        r: 0.8 + Math.random()*2.6,
        vx: -0.3 + Math.random()*0.6,
        vy: 0.6 + Math.random()*1.6,
        wobble: Math.random()*Math.PI*2
      }));
    }
    window.addEventListener("resize", resizeSnow, { passive:true });
    resizeSnow();
    (function tickSnow(){
      nCtx.clearRect(0,0,nw,nh);
      nCtx.fillStyle = "rgba(255,255,255,0.85)";
      const t = Date.now() * 0.001;
      for(const p of snow){
        p.wobble += 0.008;
        p.x += p.vx + Math.sin(p.wobble + t) * 0.25;
        p.y += p.vy;
        if(p.y > nh + 10){ p.y = -10; p.x = Math.random()*nw; }
        if(p.x < -10) p.x = nw + 10;
        if(p.x > nw + 10) p.x = -10;
        nCtx.beginPath();
        nCtx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        nCtx.fill();
      }
      requestAnimationFrame(tickSnow);
    })();

    // ===================== CANVAS: SPARK + HEART =====================
    const sparkC = document.getElementById("spark");
    const sCtx = sparkC.getContext("2d", { alpha:true });
    let sw=0, sh=0;
    function resizeSpark(){
      sw = sparkC.width = window.innerWidth;
      sh = sparkC.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeSpark, { passive:true });
    resizeSpark();

    const sparks = Array.from({ length: SPARK_COUNT }, () => ({
      angle: Math.random() * Math.PI * 2,
      baseRadius: 150 + Math.random() * 190,
      speed: 0.010 + Math.random() * 0.024,
      size: 0.8 + Math.random() * 3.6,
      color: GOLD[(Math.random() * GOLD.length) | 0],
      offsetY: (Math.random() - 0.5) * 95,
      pulse: 0.02 + Math.random() * 0.05
    }));

    const heartTargets = [];
    (function buildHeartTargets(){
      const pts = 220;
      for(let i=0;i<pts;i++){
        const t = (i/pts) * Math.PI * 2;
        const x = 16*Math.pow(Math.sin(t),3);
        const y = -(13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t));
        heartTargets.push({ x, y });
      }
    })();

    function clearSparks(){ sCtx.clearRect(0,0,sw,sh); }

    function drawSwirl(timeSec){
      const progress = Math.max(0, Math.min(1, timeSec / REVEAL_AT));
      const cx = sw/2;
      const cy = sh/2 + SWIRL_Y_OFFSET;

      const base = 280 * (1 - progress);
      const speedMul = 1 + (progress * 24);

      sCtx.save();
      for(const p of sparks){
        p.angle += p.speed * speedMul;
        const r = base + (p.baseRadius * (1 - progress));
        if(r < 0) continue;

        const x = cx + Math.cos(p.angle) * r;
        const y = cy + Math.sin(p.angle) * r + (p.offsetY * (1 - progress));

        const glow = 12 + progress * 30;
        const osc = 0.5 + Math.abs(Math.sin(Date.now() * p.pulse)) * 0.5;
        const alpha = (0.16 + progress * 0.84) * osc;

        sCtx.shadowBlur = glow;
        sCtx.shadowColor = p.color;
        sCtx.fillStyle = p.color;
        sCtx.globalAlpha = alpha;

        sCtx.beginPath();
        sCtx.arc(x, y, p.size, 0, Math.PI*2);
        sCtx.fill();
      }
      sCtx.restore();
    }

    function drawHeart(phase01){
      const cx = sw/2;
      const cy = sh/2 + SWIRL_Y_OFFSET - 20;
      const scale = Math.min(sw, sh) * 0.0105;
      const jitter = (1 - phase01) * 14;

      sCtx.save();
      for(let i=0;i<heartTargets.length;i++){
        const pt = heartTargets[i];
        const col = GOLD[i % GOLD.length];
        const x = cx + pt.x*scale + (Math.random()*2-1)*jitter;
        const y = cy + pt.y*scale + (Math.random()*2-1)*jitter;

        const alpha = 0.18 + phase01*0.82;
        const size = 1.2 + phase01*2.2;
        const glow = 10 + phase01*26;

        sCtx.globalAlpha = alpha;
        sCtx.shadowBlur = glow;
        sCtx.shadowColor = col;
        sCtx.fillStyle = col;

        sCtx.beginPath();
        sCtx.arc(x, y, size, 0, Math.PI*2);
        sCtx.fill();
      }
      sCtx.restore();
    }

    function drawSparks(timeSec){
      clearSparks();
      if(!started || opened) return;

      drawSwirl(timeSec);

      if(timeSec >= HEART_FORM_START && timeSec <= HEART_FORM_END){
        const phase = (timeSec - HEART_FORM_START) / (HEART_FORM_END - HEART_FORM_START);
        drawHeart(phase);
      }else if(timeSec > HEART_FORM_END && timeSec < REVEAL_AT){
        const phase = Math.max(0, 1 - (timeSec - HEART_FORM_END) / 0.6);
        if(phase > 0) drawHeart(phase);
      }
    }

    // ===================== CONFETTI + FIREWORKS (unchanged) =====================
    const confC = document.getElementById("confetti");
    const cCtx = confC.getContext("2d", { alpha:true });
    let cw=0, ch=0;
    function resizeConf(){ cw = confC.width = innerWidth; ch = confC.height = innerHeight; }
    addEventListener("resize", resizeConf, { passive:true }); resizeConf();

    const confetti = [];
    const CONF_COLS = ["#fff1c6","#ffdc96","#ff6fb2","#ffffff","#ffd700","#b1133e"];
    function confettiBurst(){
      const x0 = cw/2, y0 = ch/2 - 90;
      for(let i=0;i<CONFETTI_BURST;i++){
        const a = Math.random()*Math.PI*2;
        const sp = 3 + Math.random()*10;
        confetti.push({
          x:x0, y:y0,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp - (3 + Math.random()*6),
          g: 0.10 + Math.random()*0.13,
          w: 6 + Math.random()*12,
          h: 4 + Math.random()*10,
          rot: Math.random()*Math.PI,
          vr: (-0.30 + Math.random()*0.60),
          life: 140 + Math.random()*100,
          col: CONF_COLS[(Math.random()*CONF_COLS.length)|0]
        });
      }
    }
    (function tickConfetti(){
      cCtx.clearRect(0,0,cw,ch);
      if(confetti.length){
        for(let i=confetti.length-1;i>=0;i--){
          const p = confetti[i];
          p.life -= 1; p.vy += p.g; p.x += p.vx; p.y += p.vy; p.rot += p.vr;
          const a = Math.max(0, Math.min(1, p.life/160));
          cCtx.globalAlpha = a; cCtx.fillStyle = p.col;
          cCtx.translate(p.x, p.y); cCtx.rotate(p.rot);
          cCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          cCtx.setTransform(1,0,0,1,0,0);
          if(p.life <= 0 || p.y > ch + 70) confetti.splice(i,1);
        }
      }
      requestAnimationFrame(tickConfetti);
    })();

    const fireC = document.getElementById("fireworks");
    const fCtx = fireC.getContext("2d", { alpha:true });
    let fw=0, fh=0;
    function resizeFire(){ fw = fireC.width = innerWidth; fh = fireC.height = innerHeight; }
    addEventListener("resize", resizeFire, { passive:true }); resizeFire();

    const fwParts = [];
    const FW_COLS = ["#fff1c6","#ffdc96","#ffffff","#ffd700","#ff6fb2"];
    function addFireworkBurst(cx, cy){
      for(let i=0;i<FIREWORK_PARTS;i++){
        const a = Math.random()*Math.PI*2;
        const sp = 2.5 + Math.random()*6.5;
        fwParts.push({
          x: cx, y: cy,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          g: 0.028 + Math.random()*0.03,
          r: 1.0 + Math.random()*2.1,
          life: 70 + Math.random()*45,
          col: FW_COLS[(Math.random()*FW_COLS.length)|0],
          fade: 0.9 + Math.random()*0.2
        });
      }
    }
    function fireworksShow(){
      const baseX = fw/2, baseY = fh/2 - 90;
      for(let i=0;i<FIREWORK_BURSTS;i++){
        const ox = (-180 + Math.random()*360);
        const oy = (-140 + Math.random()*240);
        setTimeout(() => addFireworkBurst(baseX + ox, baseY + oy), i*85);
      }
    }
    (function tickFireworks(){
      fCtx.clearRect(0,0,fw,fh);
      for(let i=fwParts.length-1;i>=0;i--){
        const p = fwParts[i];
        p.life -= 1; p.vy += p.g; p.x += p.vx; p.y += p.vy;
        const a = Math.max(0, Math.min(1, (p.life/90) * p.fade));
        fCtx.globalAlpha = a;
        fCtx.shadowBlur = 18; fCtx.shadowColor = p.col;
        fCtx.fillStyle = p.col;
        fCtx.beginPath(); fCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); fCtx.fill();
        if(p.life <= 0) fwParts.splice(i,1);
      }
      requestAnimationFrame(tickFireworks);
    })();

    // ===================== OPEN / REVEAL =====================
    let wroteSound = false;

    function openGift(){
      if(opened) return;
      opened = true;

      aura.classList.remove("on");
      spot.style.opacity = 0.99;

      // open class on SCENE so both gift + letter animate
      scene.classList.add("open");
      reveal.classList.add("show");

      // sound design sequence
      chime();
      setTimeout(waxStamp, 720);     // stamp sound aligned with mono/wax pulse
      confettiBurst();
      fireworksShow();

      bloom.classList.add("on");
      setTimeout(() => bloom.classList.remove("on"), 900);

      wrap.classList.remove("punch");
      void wrap.offsetWidth;
      wrap.classList.add("punch");

      pill.style.display = "none";
      hint.textContent = "üéÅ √úberraschung ge√∂ffnet! ‚ù§Ô∏è";
      clearSparks();

      if(!wroteSound){
        wroteSound = true;
        setTimeout(() => typewriter(2.2), 850);
      }
    }

    // ===================== MAIN LOOP =====================
    function loop(){
      if(!started || opened) return;

      const t = (music && !isNaN(music.currentTime)) ? music.currentTime : 0;
      drawSparks(t);

      if(t < REVEAL_AT){
        const left = Math.ceil(REVEAL_AT - t);
        pillText.textContent = `Sternenstaub sammelt sich‚Ä¶ (${left}s)`;
        requestAnimationFrame(loop);
      }else{
        openGift();
      }
    }

    // ===================== START =====================
    async function start(withMusic){
      if(started) return;
      started = true;

      startBtn.disabled = true;
      startBtn.style.display = "none";

      aura.classList.add("on");
      spot.style.opacity = 1;
      pill.style.display = "inline-flex";
      hint.textContent = withMusic ? "‚ú® Magie l√§uft‚Ä¶" : "‚ú® Magie l√§uft (ohne Musik)‚Ä¶";

      try{
        const ctx = ensureAudio();
        if(ctx.state === "suspended") await ctx.resume();
      }catch(_){}

      if(withMusic){
        try{
          await music.play();
        }catch(e){
          hint.textContent = "Tippe nochmal (Browser blockiert manchmal Musik beim ersten Klick).";
          document.addEventListener("pointerdown", async function retryOnce(){
            document.removeEventListener("pointerdown", retryOnce);
            try{ await music.play(); }catch(_){}
          }, { once:true });
        }
        requestAnimationFrame(loop);
      }else{
        const startTime = performance.now();
        const fake = () => {
          if(opened) return;
          const elapsed = (performance.now() - startTime) / 1000;
          drawSparks(elapsed);

          const left = Math.ceil(REVEAL_AT - elapsed);
          pillText.textContent = `Sternenstaub sammelt sich‚Ä¶ (${Math.max(0,left)}s)`;

          if(elapsed >= REVEAL_AT) openGift();
          else requestAnimationFrame(fake);
        };
        requestAnimationFrame(fake);
      }
    }

    startBtn.addEventListener("click", () => start(true));

    window.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !started) start(true);
      if(e.key.toLowerCase() === "s" && !started) start(false);
    });
  </script>
</body>
</html>
